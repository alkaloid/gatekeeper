---
- hosts: all
  tasks:
  - name: Ensure the system can use the HTTPS transport for APT
    stat:
      path: /usr/lib/apt/methods/https
    register: apt_https_transport

  - name: Install HTTPS transport for APT
    apt:
      pkg: apt-transport-https
      state: installed
    when: not apt_https_transport.stat.exists

- hosts: all
  roles:
    - jacoelho.elixir
  vars:
    elixir_erlang_version: "18.1"
    elixir_version: "1.1.1"
  tasks:
  - name: Install Development Erlang Headers
    apt: name=erlang-dev state=latest
  - name: Install cmake
    apt: name=cmake state=latest
  - name: Install NodeJS
    apt: name=nodejs state=latest
  - name: Install NodeJS Legacy (needed for brunch)
    apt: name=nodejs-legacy state=latest
  - name: Install NPM
    apt: name=npm state=latest
  - name: Install PostgreSQL
    apt: name=postgresql state=latest
  - name: Install python-psycopg2 (required for Ansible)
    apt: name=python-psycopg2 state=latest

- hosts: all
  sudo: yes
  sudo_user: postgres
  tasks:
  - name: Create Gatekeeper database role
    postgresql_user: "name=gatekeeper password={{ postgresql_password }}"

  - name: Create Gatekeeper database
    postgresql_db: name=gatekeeper owner=gatekeeper template=template0

- hosts: all
  roles:
    - jacoelho.phoenix-app
  vars:
    phoenix_app_name: gatekeeper
    phoenix_app_user: gatekeeper
    phoenix_app_group: gatekeeper
    phoenix_app_path: /var/www
    phoenix_app_port: 4000
    phoenix_app_mix_env: prod
    phoenix_app_repository: "https://github.com/alkaloid/gatekeeper.git"
    phoenix_app_version: master
    phoenix_app_run_brunch: true
    phoenix_app_run_migrate: true
    phoenix_app_env: {}
    phoenix_app_configs: []
